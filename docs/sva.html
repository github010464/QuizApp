<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVA Quiz</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css?display=swap"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: monospace, Arial, sans-serif;
        background-color: #f4f4f4;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
        overflow-y: auto;
        scroll-behavior: smooth;
      }

      #quizContainer {
        width: 100%;
        max-width: 700px;
        /* background-color: #fff; */
        border-radius: 8px;
        /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */
        box-sizing: border-box;
        min-height: 60vh;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }

      .question-card {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
      }

      .question-title {
        font-size: 1em;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
      }

      .choices,
      .options {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .choice,
      .choice-item {
        background-color: #eef;
        border: 1px solid #dcdcdc;
        border-radius: 5px;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        display: flex;
        align-items: center;
      }

      .choice:hover,
      .choice-item:hover:not(.correct):not(.wrong) {
        background-color: #e0e0ff;
      }

      .choice.correct,
      .choice-item.correct {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .choice.wrong,
      .choice-item.wrong {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .choice .icon {
        margin-right: 10px;
        font-weight: bold;
        font-size: 1.1em;
      }

      .explanation {
        margin-top: 15px;
        border-radius: 15px;
        width: 100%;
      }

      .explanation-label {
        font-weight: bold;
        margin-top: 8px;
        margin-bottom: 4px;
      }

      .explanation-content-success {
        background-color: #e2f0d9;
        border: 1px solid #a8d591;
        color: #386d22;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
      }

      .explanation-content-error {
        background-color: #fce4e4;
        border: 1px solid #f0b0b0;
        color: #8c2f2f;
        padding: 10px;
        border-radius: 5px;
      }

      .feedback-success {
        color: #28a745;
        font-weight: bold;
        margin-bottom: 8px;
        border-radius: 5px;
      }

      .feedback-error {
        color: #dc3545;
        font-weight: bold;
        margin-bottom: 8px;
        border-radius: 5px;
      }

      .quiz-actions-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 0;
        box-sizing: border-box;
        width: 100%;
      }

      #tryNewQuizBtn {
        display: none;
        width: auto;
        font-family: "Roboto", Arial, sans-serif;
        padding: 8px 18px;
        background-color: green;
        color: #eee;
        font-size: 0.9rem;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease;
      }

      #tryNewQuizBtn:hover {
        background-color: #0b320d;
      }

      #congratsMessage {
        display: none;
        margin-top: 10px;
        padding: 12px;
        background-color: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
        border-radius: 8px;
        font-size: 1em;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
      }

      .floating-home {
        display: block !important;
        position: fixed;
        bottom: 16px;
        right: 16px;
        width: 48px;
        height: 48px;
        background: green;
        color: whitesmoke;
        font-size: 22px;
        padding: 0;
        border-radius: 50%;
        text-align: center;
        line-height: 48px;
        text-decoration: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        z-index: 9999;
        transition: background 0.3s ease, transform 0.2s ease;
      }

      .floating-home:hover {
        background: #555;
        transform: scale(1.1);
      }

      .title-header {
        text-align: center;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .title-header:hover {
        color: green;
      }

      .question-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
        padding: 16px 20px;
        margin-bottom: 18px;
        font-size: 14px;
      }

      .question-title {
        font-weight: 600;
        margin-bottom: 10px;
        line-height: 1.4;
      }

      @media (max-width: 480px) {
        .floating-home {
          bottom: 12px;
          right: 12px;
          width: 44px;
          height: 44px;
          font-size: 20px;
          line-height: 44px;
        }

        .sva-rules-container {
          font-size: 0.85rem;
        }

        .list-wrapper {
          padding-left: 20px;
        }

        .bonus-tips {
          font-size: 0.85rem;
          padding-left: 20px;
        }
      }

      @media (min-width: 768px) {
        body {
          padding: 24px;
        }

        .title-header {
          margin-bottom: 24px;
          font-size: 32px;
          margin-top: 0;
        }
        .question-title {
          margin-bottom: 12px;
        }

        .choice {
          padding: 12px 16px;
          margin-bottom: 12px;
        }

        .choice .icon {
          width: 18px;
          height: 18px;
          margin-right: 8px;
        }

        .choice-item {
          padding: 12px 18px;
          margin-bottom: 12px;
        }

        .choice-item input[type="radio"] {
          transform: scale(1.2);
          margin-right: 12px;
        }

        .explanation {
          margin-top: 12px;
          font-size: 0.95rem;
        }

        .feedback-success,
        .feedback-error {
          margin-bottom: 10px;
        }

        .quiz-actions-container {
          max-width: 700px;
          margin-top: 0px;
        }

        #tryNewQuizBtn {
          padding: 8px 18px;
          font-size: 0.95em;
        }
      }
    </style>
  </head>

  <body>
    <a href="index.html" class="floating-home" title="Go Home">
      <i class="fa-solid fa-house"></i>
    </a>
    <h3 class="title-header">Subjectâ€“Verb Agreement Quiz</h3>

    <div id="quizContainer">Loading quiz...</div>

    <div class="quiz-actions-container">
      <button id="tryNewQuizBtn">Next Quiz</button>
      <div id="congratsMessage">
        ðŸŽ‰ Congratulations! You've completed all quizzes! ðŸŽ‰
      </div>
    </div>

    <script>
      // localStorage.setItem(CURRENT_QUIZ_INDEX_KEY, 0); // Always start at first quiz

      /* ---------- GLOBAL VARIABLES ---------- */
      let quizData = []; // Stores the current quiz's questions
      let totalQuestions = 0; // Total questions in the current quiz
      let answeredQuestionsCount = 0; // Questions answered in the current quiz

      // Local Storage Keys
      const QUIZ_COUNT_KEY = "completedQuizCount"; // General counter (optional)
      const COMPLETED_QUIZZES_LIST_KEY = "completedQuizPages"; // To track which specific quizzes are done optional)
      const CURRENT_QUIZ_INDEX_KEY = "currentQuizIndex"; // Crucial for progression
      localStorage.setItem(CURRENT_QUIZ_INDEX_KEY, 0);

      // DOM Elements
      const tryBtn = document.getElementById("tryNewQuizBtn");
      const quizContainer = document.getElementById("quizContainer");
      const congratsMessage = document.getElementById("congratsMessage");

      // Quiz Sequence Definition
      // IMPORTANT: List all your quiz JSON files in order here.
      // Example: If you have sva1.json, sva2.json, sva3.json, etc.
      const QUIZ_FILES_SEQUENCE = [
        "sva1.json",
        "sva2.json",
        "sva3.json",
        "sva4.json",
      ]; // Add all your quiz files here!

      // Retrieve current quiz index from local storage, default to 0 (for 1st quiz in sequence)
      // If localStorage is empty or invalid, start from the very first quiz (index 0).
      let currentQuizIndex = parseInt(
        localStorage.getItem(CURRENT_QUIZ_INDEX_KEY)
      );
      if (
        isNaN(currentQuizIndex) ||
        currentQuizIndex < 0 ||
        currentQuizIndex >= QUIZ_FILES_SEQUENCE.length
      ) {
        currentQuizIndex = 0; // Default to the first quiz
        localStorage.setItem(CURRENT_QUIZ_INDEX_KEY, currentQuizIndex); // Store the default
      }

      /* ---------- INIT ---------- */
      // Load the initial quiz based on the currentQuizIndex
      loadQuiz(QUIZ_FILES_SEQUENCE[currentQuizIndex]);

      /* ---------- LOAD QUIZ DATA ---------- */
      function loadQuiz(filename) {
        console.log(`Attempting to load quiz: ${filename}`); // Debugging
        fetch(filename)
          .then((res) => {
            if (!res.ok) {
              // If response is not OK (e.g., 404 Not Found, 500 Internal Server Error)
              throw new Error(
                `HTTP error! Status: ${res.status} for ${filename}`
              );
            }
            return res.json();
          })
          .then((data) => {
            if (data.length === 0) {
              console.warn(`Quiz data for ${filename} is empty.`);
              quizContainer.textContent = "Quiz is empty or invalid.";
              tryBtn.style.display = "none";
              congratsMessage.style.display = "none";
              return;
            }
            quizData = shuffleArray(data); // Shuffle questions
            totalQuestions = quizData.length;
            answeredQuestionsCount = 0; // Reset for new quiz
            tryBtn.style.display = "none"; // Hide button until this quiz is completed
            congratsMessage.style.display = "none"; // Hide congrats message on new quiz load
            renderQuiz(quizData); // Display the loaded quiz
            window.scrollTo({ top: 0, behavior: "smooth" }); // Scroll to top for new quiz
          })
          .catch((err) => {
            // Display a user-friendly error message
            quizContainer.innerHTML = `<p style="color: red;">Failed to load quiz: ${filename}. Please check the file path and JSON format.</p>`;
            console.error("Error loading quiz data:", err); // Log full error for debugging
            tryBtn.style.display = "none"; // Ensure button is hidden
            congratsMessage.style.display = "none"; // Ensure congrats is hidden
          });
      }

      /* ---------- RENDER QUIZ ---------- */
      function renderQuiz(data) {
        quizContainer.innerHTML = ""; // Clear previous content

        data.forEach((q, qi) => {
          const card = document.createElement("div");
          card.className = "question-card";
          card.dataset.questionIndex = qi;
          card.dataset.answered = "false"; // Tracks if this specific question has been answered

          // Assuming JSON 1 format {prompt, choices, correctIndex, explanation}
          card.innerHTML = `
                    <p class="question-title">${qi + 1}. ${q.prompt}</p>
                    <ul class="choices"></ul>
                    <div class="explanation" hidden></div> `;

          const ul = card.querySelector(".choices");

          q.choices.forEach((choiceText, ci) => {
            const li = document.createElement("li");
            li.className = "choice";
            li.dataset.isCorrect = ci === q.correctIndex;
            li.innerHTML = `<span class="icon"></span><span>${choiceText}</span>`;
            li.addEventListener("click", () => handleChoice(li, card, q));
            ul.appendChild(li);
          });

          quizContainer.appendChild(card);
        });
      }

      /* ---------- HANDLE CHOICE ---------- */
      function handleChoice(selectedElement, card, q) {
        if (card.dataset.answered === "true") return; // Prevent re-answering
        card.dataset.answered = "true";
        answeredQuestionsCount++;

        const isCorrect = selectedElement.dataset.isCorrect === "true";
        selectedElement.classList.add(isCorrect ? "correct" : "wrong");
        selectedElement.querySelector(".icon").textContent = isCorrect
          ? "âœ“"
          : "âœ—";

        // If incorrect, highlight the correct answer
        if (!isCorrect) {
          [...card.querySelectorAll(".choice")].forEach((c) => {
            if (c !== selectedElement && c.dataset.isCorrect === "true") {
              c.classList.add("correct");
              c.querySelector(".icon").textContent = "âœ“";
            }
          });
        }

        // Display explanation
        const expEl = card.querySelector(".explanation");
        expEl.innerHTML = `
                <div class="${
                  isCorrect ? "feedback-success" : "feedback-error"
                }" style="margin-bottom: 8px;">
                    ${
                      isCorrect
                        ? "That's correct! Here's why:"
                        : "Incorrect! Here's the explanation."
                    }
                </div>
                <div class="${
                  isCorrect
                    ? "explanation-content-success"
                    : "explanation-content-error"
                }">
                    ${q.explanation || "No explanation provided."}
                </div>
            `;
        expEl.hidden = false;

        // Check if all questions are answered
        if (answeredQuestionsCount === totalQuestions) {
          handleCompletion();
        }
      }

      /* ---------- ON COMPLETION ---------- */
      function handleCompletion() {
        // Determine if there's a next quiz in the sequence
        const hasNextQuiz = currentQuizIndex + 1 < QUIZ_FILES_SEQUENCE.length;

        if (hasNextQuiz) {
          tryBtn.textContent = "Next Quiz";
          tryBtn.style.display = "block"; // Show "Next Quiz" button
          congratsMessage.style.display = "none"; // Hide congratulations message
        } else {
          // This is the last quiz
          tryBtn.style.display = "none"; // Hide the button
          congratsMessage.style.display = "block"; // Show the final congratulations
        }

        // Scroll the button (or the congrats message) into view
        // Use setTimeout to ensure display:block has rendered
        setTimeout(() => {
          if (tryBtn.style.display === "block") {
            tryBtn.scrollIntoView({ behavior: "smooth", block: "center" });
          } else if (congratsMessage.style.display === "block") {
            congratsMessage.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }
        }, 150);

        // Optional: Update general quiz completion counter
        let count = parseInt(localStorage.getItem(QUIZ_COUNT_KEY)) || 0;
        count++;
        localStorage.setItem(QUIZ_COUNT_KEY, count);
      }

      /* ---------- NEXT QUIZ BUTTON CLICK HANDLER ---------- */
      tryBtn.addEventListener("click", () => {
        // First, ensure all questions in the current quiz have been answered
        if (answeredQuestionsCount < totalQuestions) {
          alert(
            "Please answer all questions first before proceeding to the next quiz."
          );
          console.log(
            "DEBUG: Next Quiz button clicked, but not all questions answered. currentQuizIndex will NOT increment."
          );
          return; // Stop execution
        }

        console.log(
          "DEBUG: Before increment - currentQuizIndex:",
          currentQuizIndex
        );
        currentQuizIndex++; // Increment the index for the next quiz
        console.log(
          "DEBUG: After increment - currentQuizIndex:",
          currentQuizIndex
        );

        // Store the new currentQuizIndex in local storage for persistence
        localStorage.setItem(CURRENT_QUIZ_INDEX_KEY, currentQuizIndex);
        console.log(
          "DEBUG: currentQuizIndex saved to localStorage as:",
          localStorage.getItem(CURRENT_QUIZ_INDEX_KEY)
        );

        // Check if there are more quizzes in the sequence
        if (currentQuizIndex < QUIZ_FILES_SEQUENCE.length) {
          // Load the next quiz in the sequence
          loadQuiz(QUIZ_FILES_SEQUENCE[currentQuizIndex]);
        } else {
          // No more quizzes: display final congratulations and hide button
          tryBtn.style.display = "none";
          congratsMessage.style.display = "block";
          congratsMessage.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
          // Reset quiz index if all quizzes are completed (optional, for restarting flow)
          // localStorage.setItem(CURRENT_QUIZ_INDEX_KEY, 0); // Uncomment to reset to first quiz after completion
        }

        // Optional: Track which specific quiz pages have been completed
        let completed =
          JSON.parse(localStorage.getItem(COMPLETED_QUIZZES_LIST_KEY)) || [];
        // We store the index of the quiz just completed (currentQuizIndex - 1)
        if (
          !completed.includes(currentQuizIndex - 1) &&
          currentQuizIndex - 1 >= 0
        ) {
          completed.push(currentQuizIndex - 1);
        }
        localStorage.setItem(
          COMPLETED_QUIZZES_LIST_KEY,
          JSON.stringify(completed)
        );
      });

      /* ---------- SHUFFLE ARRAY (for questions) ---------- */
      function shuffleArray(array) {
        let arr = array.slice(); // Create a shallow copy to avoid modifying original array
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]]; // ES6 swap
        }
        return arr;
      }

      window.history.scrollRestoration = "manual";

      function forceScrollTop() {
        if (location.hash) {
          history.replaceState(null, null, location.pathname);
        }

        // Blur any focused element
        if (document.activeElement) {
          document.activeElement.blur();
        }

        // Multiple forced scrolls
        setTimeout(() => window.scrollTo(0, 0), 0);
        setTimeout(() => window.scrollTo(0, 0), 100);
        setTimeout(() => window.scrollTo(0, 0), 300);
        setTimeout(() => window.scrollTo(0, 0), 500);
      }

      window.addEventListener("load", forceScrollTop);
    </script>
  </body>
</html>
